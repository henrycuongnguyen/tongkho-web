---
/**
 * News Article Detail Page
 * Dynamic route for individual news articles
 * URL: /tin-tuc/{slug}
 */
import MainLayout from '@/layouts/main-layout.astro';
import ArticleShareButtons from '@/components/news/article-share-buttons.astro';
import RelatedArticlesSidebar from '@/components/news/news-related-articles-sidebar.astro';
import { postgresNewsProjectService } from '@/services/postgres-news-project-service';
import { formatRelativeTime } from '@/utils/format';
import type { NewsArticle, NewsCategory } from '@/types/property';

// Get slug from URL params
const { slug } = Astro.params;

// Fetch article from PostgreSQL
const article = slug ? await postgresNewsProjectService.getNewsBySlug(slug) : null;

// Return 404 if article not found
if (!article) {
  return Astro.redirect('/404');
}

// Category label mapping
const categoryLabels: Record<NewsCategory, string> = {
  market: 'Thị trường',
  tips: 'Kiến thức',
  policy: 'Chính sách',
  project_news: 'Dự án',
  investment: 'Đầu tư',
};

// Category color mapping
const categoryColors: Record<NewsCategory, string> = {
  market: 'bg-blue-500',
  tips: 'bg-green-500',
  policy: 'bg-purple-500',
  project_news: 'bg-orange-500',
  investment: 'bg-amber-500',
};

// SEO
const pageTitle = `${article.title} | TongkhoBDS`;
const pageDescription = article.excerpt;
const articleUrl = `/tin-tuc/${article.slug}`;
---

<MainLayout
  title={pageTitle}
  description={pageDescription}
  image={article.thumbnail}
>
  <div class="bg-secondary-50 min-h-screen pb-12">
    <!-- Hero Section with Full-width Image -->
    <div class="relative h-[300px] sm:h-[400px] lg:h-[450px] overflow-hidden">
      <img
        src={article.thumbnail}
        alt={article.title}
        class="w-full h-full object-cover"
      />
      <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-black/30 to-transparent"></div>

      <!-- Hero Content -->
      <div class="absolute bottom-0 left-0 right-0 p-6 lg:p-10">
        <div class="container-custom">
          <!-- Category Badge -->
          <span class={`inline-block px-3 py-1.5 text-sm font-semibold text-white rounded-full mb-4 ${categoryColors[article.category]}`}>
            {categoryLabels[article.category]}
          </span>

          <!-- Title -->
          <h1 class="text-2xl sm:text-3xl lg:text-4xl font-bold text-white leading-tight max-w-4xl">
            {article.title}
          </h1>
        </div>
      </div>
    </div>

    <!-- Breadcrumb -->
    <div class="container-custom py-4">
      <nav class="text-sm text-secondary-500">
        <ol class="flex flex-wrap items-center gap-2">
          <li><a href="/" class="hover:text-primary-500 transition-colors">Trang chủ</a></li>
          <li class="text-secondary-300">&gt;</li>
          <li><a href="/tin-tuc" class="hover:text-primary-500 transition-colors">Tin tức</a></li>
          <li class="text-secondary-300">&gt;</li>
          <li class="text-secondary-700 font-medium line-clamp-1">{article.title}</li>
        </ol>
      </nav>
    </div>

    <!-- Main Content -->
    <div class="container-custom">
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
        <!-- Article Content (8 cols) -->
        <article class="lg:col-span-8">
          <div class="bg-white rounded-2xl shadow-lg p-6 lg:p-8">
            <!-- Article Meta -->
            <div class="flex flex-wrap items-center gap-4 pb-6 mb-6 border-b border-secondary-100">
              <!-- Author -->
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-primary-400 to-primary-600 flex items-center justify-center text-white font-bold">
                  {article.author.charAt(0)}
                </div>
                <div>
                  <p class="font-medium text-secondary-800">{article.author}</p>
                  <p class="text-xs text-secondary-400">Tác giả</p>
                </div>
              </div>

              <div class="w-px h-8 bg-secondary-200 hidden sm:block"></div>

              <!-- Date -->
              <div class="flex items-center gap-2 text-secondary-500">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                <span class="text-sm">{new Date(article.publishedAt).toLocaleDateString('vi-VN', { day: 'numeric', month: 'long', year: 'numeric' })}</span>
              </div>

              <div class="w-px h-8 bg-secondary-200 hidden sm:block"></div>

              <!-- Views -->
              <div class="flex items-center gap-2 text-secondary-500">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                </svg>
                <span class="text-sm">{article.views.toLocaleString()} lượt xem</span>
              </div>
            </div>

            <!-- Excerpt -->
            <p class="text-lg text-secondary-600 leading-relaxed mb-8 font-medium italic border-l-4 border-primary-500 pl-4 bg-primary-50/50 py-3 rounded-r-lg">
              {article.excerpt}
            </p>

            <!-- Article Body -->
            {article.content ? (
              <div class="article-content prose prose-lg max-w-none" set:html={article.content} />
            ) : (
              <div class="text-secondary-500 italic text-center py-8">
                Nội dung bài viết đang được cập nhật...
              </div>
            )}

            <!-- Share Section -->
            <div class="mt-8 pt-6 border-t border-secondary-100">
              <ArticleShareButtons url={articleUrl} title={article.title} />
            </div>

            <!-- Tags -->
            <div class="mt-6 pt-6 border-t border-secondary-100">
              <div class="flex flex-wrap items-center gap-2">
                <span class="text-secondary-500 text-sm">Tags:</span>
                <a href={`/tin-tuc?category=${article.category}`} class="px-3 py-1 text-sm bg-secondary-100 text-secondary-600 rounded-full hover:bg-primary-100 hover:text-primary-600 transition-colors">
                  {categoryLabels[article.category]}
                </a>
                <a href="/tin-tuc" class="px-3 py-1 text-sm bg-secondary-100 text-secondary-600 rounded-full hover:bg-primary-100 hover:text-primary-600 transition-colors">
                  Tin tức BDS
                </a>
              </div>
            </div>
          </div>

          <!-- Mobile Related Articles -->
          <div class="lg:hidden mt-8">
            <RelatedArticlesSidebar currentSlug={article.slug} category={article.category} />
          </div>
        </article>

        <!-- Sidebar (4 cols) -->
        <aside class="lg:col-span-4 space-y-6 hidden lg:block">
          <!-- Related Articles -->
          <div class="sticky top-24">
            <RelatedArticlesSidebar currentSlug={article.slug} category={article.category} />
          </div>
        </aside>
      </div>
    </div>
  </div>
</MainLayout>

<style is:global>
  /* Article content typography - using CSS variables for custom theme colors */
  .article-content h2 {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--color-secondary-800);
    margin-top: 2rem;
    margin-bottom: 1rem;
  }

  @media (min-width: 640px) {
    .article-content h2 {
      font-size: 1.5rem;
    }
  }

  .article-content h3 {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--color-secondary-800);
    margin-top: 1.5rem;
    margin-bottom: 0.75rem;
  }

  @media (min-width: 640px) {
    .article-content h3 {
      font-size: 1.25rem;
    }
  }

  .article-content p {
    color: var(--color-secondary-700);
    line-height: 1.625;
    margin-bottom: 1rem;
  }

  .article-content ul,
  .article-content ol {
    margin-bottom: 1rem;
    padding-left: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .article-content ul {
    list-style-type: disc;
  }

  .article-content ol {
    list-style-type: decimal;
  }

  .article-content li {
    color: var(--color-secondary-700);
    line-height: 1.625;
  }

  .article-content a {
    color: var(--color-primary-500);
    text-decoration: underline;
  }

  .article-content a:hover {
    color: var(--color-primary-600);
  }

  .article-content blockquote {
    border-left: 4px solid var(--color-primary-500);
    padding-left: 1rem;
    font-style: italic;
    color: var(--color-secondary-600);
    margin: 1.5rem 0;
    background-color: var(--color-secondary-50);
    padding-top: 0.75rem;
    padding-bottom: 0.75rem;
    border-radius: 0 0.5rem 0.5rem 0;
  }

  .article-content img {
    border-radius: 0.75rem;
    margin: 1.5rem 0;
    width: 100%;
  }

  .article-content strong {
    font-weight: 600;
    color: var(--color-secondary-800);
  }
</style>
