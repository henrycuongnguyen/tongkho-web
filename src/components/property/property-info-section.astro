---
import type { Property, PropertyType, TransactionType } from '@/types/property';
import { formatPrice, formatRelativeTime } from '@/utils/format';
// PriceHistoryChart moved to separate card in [slug].astro

interface Props {
  property: Property;
}

const { property } = Astro.props;

// Property type labels
const propertyTypeLabels: Record<PropertyType, string> = {
  apartment: 'Căn hộ',
  house: 'Nhà phố',
  villa: 'Biệt thự',
  land: 'Đất nền',
  office: 'Văn phòng',
  shophouse: 'Shophouse',
  warehouse: 'Kho xưởng',
};

// Transaction type labels
const transactionTypeLabels: Record<TransactionType, string> = {
  sale: 'Bán',
  rent: 'Cho thuê',
};

// Calculate price per m2
const pricePerM2 = property.priceUnit === 'billion'
  ? (property.price * 1000000000 / property.area).toFixed(0)
  : property.priceUnit === 'million'
  ? (property.price * 1000000 / property.area).toFixed(0)
  : null;

const isLongDescription = property.description.length > 300;
---

<section class="bg-white rounded-xl shadow-sm border border-secondary-100 p-6 md:p-8">
  <!-- Title + Price Row -->
  <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4 mb-4 pb-4 border-b border-secondary-100">
    <!-- Title -->
    <h1 class="text-2xl md:text-3xl font-bold text-secondary-800 flex-1">
      {property.title}
    </h1>

    <!-- Price -->
    <div class="shrink-0 text-right">
      <div class="text-2xl md:text-3xl font-bold text-primary-500">
        {formatPrice(property.price, property.priceUnit)}
      </div>
      {pricePerM2 && (
        <div class="text-sm text-secondary-500">
          {property.area} m² - {(parseInt(pricePerM2) / 1000000).toFixed(0)} triệu/m²
        </div>
      )}
    </div>
  </div>

  <!-- Share Actions Row -->
  <div class="flex items-center justify-between gap-4 mb-6 pb-6 border-b border-secondary-100">
    <span class="text-sm text-secondary-500">Chia sẻ tin này:</span>
    <div class="flex items-center gap-2">
      <!-- Facebook -->
      <button
        class="share-social-btn w-9 h-9 flex items-center justify-center rounded-lg bg-[#1877F2] hover:bg-[#0d65d9] transition-all duration-200 cursor-pointer"
        data-platform="facebook"
        data-url={`/bat-dong-san/${property.slug}`}
        data-title={property.title}
        title="Chia sẻ lên Facebook"
      >
        <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M18 2h-3a5 5 0 00-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 011-1h3z"/></svg>
      </button>
      <!-- Zalo -->
      <button
        class="share-social-btn w-9 h-9 flex items-center justify-center rounded-lg bg-[#0068FF] hover:bg-[#0055d4] transition-all duration-200 cursor-pointer"
        data-platform="zalo"
        data-url={`/bat-dong-san/${property.slug}`}
        data-title={property.title}
        title="Chia sẻ lên Zalo"
      >
        <svg class="w-4 h-4 text-white" viewBox="0 0 24 24" fill="currentColor"><path d="M12.5 21.5c5 0 9.5-3.5 9.5-8.5S17.5 4.5 12.5 4.5 3 8 3 13s4.5 8.5 9.5 8.5zm-3-12h6c.3 0 .5.2.5.5s-.2.5-.5.5h-5.2l-1 2h4.7c.3 0 .5.2.5.5v3c0 .3-.2.5-.5.5h-4c-.3 0-.5-.2-.5-.5v-2.2l-1.5 2.5c-.1.2-.4.2-.5.1-.2-.1-.2-.4-.1-.5l2-3.3V10c0-.3.2-.5.5-.5z"/></svg>
      </button>
      <!-- Twitter/X -->
      <button
        class="share-social-btn w-9 h-9 flex items-center justify-center rounded-lg bg-black hover:bg-secondary-800 transition-all duration-200 cursor-pointer"
        data-platform="twitter"
        data-url={`/bat-dong-san/${property.slug}`}
        data-title={property.title}
        title="Chia sẻ lên X (Twitter)"
      >
        <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
      </button>
      <!-- Copy Link -->
      <button
        class="share-social-btn copy-link-btn w-9 h-9 flex items-center justify-center rounded-lg bg-primary-500 hover:bg-primary-600 transition-all duration-200 cursor-pointer"
        data-platform="copy"
        data-url={`/bat-dong-san/${property.slug}`}
        title="Sao chép link"
      >
        <svg class="copy-icon w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
        <svg class="check-icon hidden w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
      </button>
      <!-- Favorite -->
      <button
        class="w-9 h-9 flex items-center justify-center rounded-lg bg-secondary-100 hover:bg-red-50 hover:text-red-500 text-secondary-500 transition-all duration-200 cursor-pointer"
        title="Lưu tin yêu thích"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
        </svg>
      </button>
      <!-- Print -->
      <button
        class="print-btn w-9 h-9 flex items-center justify-center rounded-lg bg-secondary-100 hover:bg-secondary-200 text-secondary-500 transition-all duration-200 cursor-pointer"
        title="In tin đăng"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
        </svg>
      </button>
    </div>
  </div>

  <!-- Specs Grid -->
  <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 pb-6 border-b border-secondary-100">
    <div class="flex items-center gap-2">
      <div class="w-9 h-9 rounded-lg bg-primary-50 flex items-center justify-center shrink-0">
        <svg class="w-4 h-4 text-primary-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
        </svg>
      </div>
      <div>
        <div class="text-xs text-secondary-500">Diện tích</div>
        <div class="font-semibold text-secondary-800">{property.area} m²</div>
      </div>
    </div>

    {property.bedrooms && (
      <div class="flex items-center gap-2">
        <div class="w-9 h-9 rounded-lg bg-blue-50 flex items-center justify-center shrink-0">
          <svg class="w-4 h-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
          </svg>
        </div>
        <div>
          <div class="text-xs text-secondary-500">Phòng ngủ</div>
          <div class="font-semibold text-secondary-800">{property.bedrooms} PN</div>
        </div>
      </div>
    )}

    {property.bathrooms && (
      <div class="flex items-center gap-2">
        <div class="w-9 h-9 rounded-lg bg-teal-50 flex items-center justify-center shrink-0">
          <svg class="w-4 h-4 text-teal-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z" />
          </svg>
        </div>
        <div>
          <div class="text-xs text-secondary-500">Phòng tắm</div>
          <div class="font-semibold text-secondary-800">{property.bathrooms} WC</div>
        </div>
      </div>
    )}

    <div class="flex items-center gap-2">
      <div class="w-9 h-9 rounded-lg bg-purple-50 flex items-center justify-center shrink-0">
        <svg class="w-4 h-4 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      </div>
      <div>
        <div class="text-xs text-secondary-500">Đăng tin</div>
        <div class="font-semibold text-secondary-800">{formatRelativeTime(property.createdAt)}</div>
      </div>
    </div>
  </div>

  <!-- Location -->
  <div class="mb-6 pb-6 border-b border-secondary-100">
    <h3 class="text-lg font-semibold text-secondary-800 mb-3">Vị trí</h3>
    <p class="flex gap-2 text-secondary-600">
      <svg class="w-5 h-5 text-primary-500 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
      </svg>
      {property.address}, {property.district}, {property.city}
    </p>
  </div>

  <!-- Features -->
  {property.features && property.features.length > 0 && (
    <div class="mb-6 pb-6 border-b border-secondary-100">
      <h3 class="text-lg font-semibold text-secondary-800 mb-3">Đặc điểm nổi bật</h3>
      <div class="flex flex-wrap gap-2">
        {property.features.map((feature) => (
          <span class="inline-flex items-center px-3 py-1.5 rounded-lg bg-secondary-50 text-secondary-700 text-sm border border-secondary-200">
            {feature}
          </span>
        ))}
      </div>
    </div>
  )}

  <!-- Description -->
  <div class="mb-6 pb-6 border-b border-secondary-100">
    <h3 class="text-lg font-semibold text-secondary-800 mb-3">Mô tả chi tiết</h3>
    <div class="prose prose-sm max-w-none text-secondary-600">
      {isLongDescription ? (
        <div>
          <div class="description-content" data-full-text={property.description}>
            {property.description.slice(0, 300)}...
          </div>
          <button
            class="text-primary-500 hover:text-primary-600 font-medium mt-2 transition-colors toggle-description cursor-pointer"
            data-action="expand"
          >
            Xem thêm →
          </button>
        </div>
      ) : (
        <p>{property.description}</p>
      )}
    </div>
  </div>

  <!-- Contact Info Section -->
  <div class="bg-secondary-50 rounded-xl p-5">
    <p class="text-secondary-700 mb-2">
      Tổng Kho BĐS luôn sẵn sàng đồng hành cùng bạn trên hành trình tìm kiếm bất động sản phù hợp nhất.
    </p>
    <p class="text-secondary-700 font-medium mb-4">
      Liên hệ ngay để được chuyên viên tư vấn và hỗ trợ nhanh nhất!
    </p>
    <p class="mb-2">
      <a href="/" class="text-primary-500 hover:text-primary-600 font-medium transition-colors">TongkhoBDS.com</a>
      <span class="text-secondary-600"> – Kho dữ liệu Bất động sản lớn nhất Việt Nam</span>
    </p>
    <p class="text-secondary-700 mb-1">
      <span class="font-medium">Địa chỉ:</span> 51 Kim Mã, Ba Đình, Hà Nội
    </p>
    <p class="text-secondary-700 mb-1">
      <span class="font-medium">Hotline:</span> 1900.988.998
    </p>
    <p class="text-secondary-700">
      <span class="font-medium">Email:</span>
      <a href="mailto:cskh@tongkhobds.com" class="text-primary-500 hover:text-primary-600 transition-colors">cskh@tongkhobds.com</a>
    </p>
  </div>
</section>

<script>
  // Toggle description
  document.querySelectorAll('.toggle-description').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const target = e.target as HTMLButtonElement;
      const content = target.previousElementSibling as HTMLElement;
      const full = content.dataset.fullText || '';
      const isExpanded = target.dataset.action === 'collapse';
      content.textContent = isExpanded ? full.slice(0, 300) + '...' : full;
      target.textContent = isExpanded ? 'Xem thêm →' : '← Thu gọn';
      target.dataset.action = isExpanded ? 'expand' : 'collapse';
    });
  });

  // Share social buttons
  document.querySelectorAll('.share-social-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const target = e.currentTarget as HTMLElement;
      const platform = target.dataset.platform;
      const url = window.location.origin + (target.dataset.url || '');
      const title = target.dataset.title || document.title;

      switch (platform) {
        case 'facebook':
          window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`, '_blank', 'width=600,height=400');
          break;
        case 'zalo':
          window.open(`https://zalo.me/share?url=${encodeURIComponent(url)}`, '_blank');
          break;
        case 'twitter':
          window.open(`https://twitter.com/intent/tweet?url=${encodeURIComponent(url)}&text=${encodeURIComponent(title)}`, '_blank', 'width=600,height=400');
          break;
        case 'copy':
          navigator.clipboard.writeText(url).then(() => {
            const copyIcon = target.querySelector('.copy-icon');
            const checkIcon = target.querySelector('.check-icon');
            if (copyIcon && checkIcon) {
              copyIcon.classList.add('hidden');
              checkIcon.classList.remove('hidden');
              target.classList.add('bg-green-500');
              target.classList.remove('bg-primary-500', 'hover:bg-primary-600');
              setTimeout(() => {
                copyIcon.classList.remove('hidden');
                checkIcon.classList.add('hidden');
                target.classList.remove('bg-green-500');
                target.classList.add('bg-primary-500', 'hover:bg-primary-600');
              }, 2000);
            }
          });
          break;
      }
    });
  });

  // Print button
  document.querySelectorAll('.print-btn').forEach(btn => {
    btn.addEventListener('click', () => window.print());
  });
</script>
