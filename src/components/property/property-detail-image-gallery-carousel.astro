---
interface Props {
  images: string[];
}

const { images } = Astro.props;
const totalImages = images.length;
---

<div class="image-gallery w-full">
  <div class="relative bg-white rounded-xl shadow-lg overflow-hidden mx-auto">
    <!-- Main Image Container -->
    <div class="relative aspect-video bg-secondary-100">
      <img
        id="main-image"
        src={images[0]}
        alt="Property image"
        class="w-full h-full object-cover cursor-zoom-in"
        loading="eager"
      />

      <!-- Navigation Arrows -->
      <button
        id="prev-btn"
        class="absolute left-3 top-1/2 -translate-y-1/2 w-10 h-10 flex items-center justify-center bg-white/90 backdrop-blur-sm rounded-full shadow-lg hover:bg-white hover:scale-110 transition-all duration-300 opacity-0 group-hover:opacity-100"
        aria-label="Previous image"
      >
        <svg class="w-5 h-5 text-secondary-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
      </button>

      <button
        id="next-btn"
        class="absolute right-3 top-1/2 -translate-y-1/2 w-10 h-10 flex items-center justify-center bg-white/90 backdrop-blur-sm rounded-full shadow-lg hover:bg-white hover:scale-110 transition-all duration-300 opacity-0 group-hover:opacity-100"
        aria-label="Next image"
      >
        <svg class="w-5 h-5 text-secondary-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </button>

      <!-- Zoom Icon Overlay -->
      <div class="absolute bottom-3 left-3 pointer-events-none">
        <span class="inline-flex items-center px-2.5 py-1.5 bg-black/70 text-white text-xs font-medium rounded-lg backdrop-blur-sm gap-1.5">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7" />
          </svg>
          Phóng to
        </span>
      </div>

      <!-- Image Counter Badge -->
      <div class="absolute bottom-3 right-3">
        <span class="inline-flex items-center px-3 py-1.5 bg-black/70 text-white text-sm font-medium rounded-lg backdrop-blur-sm">
          <span id="current-index">1</span>/<span>{totalImages}</span>
        </span>
      </div>
    </div>

    <!-- Thumbnail Strip -->
    <div class="relative bg-secondary-50 p-3">
      <div id="thumbnail-container" class="flex gap-2 overflow-x-auto scrollbar-hide scroll-smooth">
        {images.map((image, index) => (
          <button
            data-index={index}
            class={`thumbnail flex-shrink-0 w-20 h-14 rounded-lg overflow-hidden border-2 transition-all duration-300 ${
              index === 0 ? 'border-primary-500 ring-2 ring-primary-200' : 'border-transparent hover:border-secondary-300'
            }`}
            aria-label={`View image ${index + 1}`}
          >
            <img
              src={image}
              alt={`Thumbnail ${index + 1}`}
              class="w-full h-full object-cover"
              loading="lazy"
            />
          </button>
        ))}
      </div>
    </div>
  </div>
</div>

<!-- Lightbox Modal -->
<div id="lightbox" class="lightbox" aria-hidden="true">
  <div class="lightbox-overlay"></div>

  <div class="lightbox-content">
    <!-- Close Button -->
    <button id="lightbox-close" class="lightbox-close" aria-label="Đóng">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>

    <!-- Image Counter -->
    <div class="lightbox-counter">
      <span id="lightbox-current">1</span> / <span>{totalImages}</span>
    </div>

    <!-- Main Image Area -->
    <div class="lightbox-image-wrapper">
      <button id="lightbox-prev" class="lightbox-nav lightbox-nav-prev" aria-label="Ảnh trước">
        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
      </button>

      <div class="lightbox-image-container">
        <img id="lightbox-image" src="" alt="Property image" class="lightbox-image" />
      </div>

      <button id="lightbox-next" class="lightbox-nav lightbox-nav-next" aria-label="Ảnh tiếp">
        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </button>
    </div>

    <!-- Thumbnails Strip -->
    <div class="lightbox-thumbnails">
      <div id="lightbox-thumbnail-container" class="lightbox-thumbnail-strip">
        {images.map((image, index) => (
          <button
            data-lightbox-index={index}
            class={`lightbox-thumb ${index === 0 ? 'active' : ''}`}
            aria-label={`Xem ảnh ${index + 1}`}
          >
            <img src={image} alt={`Thumbnail ${index + 1}`} loading="lazy" />
          </button>
        ))}
      </div>
    </div>
  </div>
</div>

<style>
  .image-gallery {
    position: relative;
  }

  .image-gallery:hover #prev-btn,
  .image-gallery:hover #next-btn {
    opacity: 1;
  }

  /* Main image clickable cursor */
  #main-image {
    cursor: zoom-in;
  }

  .scrollbar-hide::-webkit-scrollbar {
    display: none;
  }

  .scrollbar-hide {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }

  /* Lightbox Styles */
  .lightbox {
    position: fixed;
    inset: 0;
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
  }

  .lightbox.active {
    opacity: 1;
    visibility: visible;
  }

  .lightbox-overlay {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.95);
  }

  .lightbox-content {
    position: relative;
    z-index: 1;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    padding: 1rem;
  }

  .lightbox-close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    z-index: 10;
    width: 44px;
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.1);
    border: none;
    border-radius: 50%;
    color: white;
    cursor: pointer;
    transition: background 0.2s ease, transform 0.2s ease;
  }

  .lightbox-close:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: scale(1.1);
  }

  .lightbox-counter {
    position: absolute;
    top: 1.25rem;
    left: 50%;
    transform: translateX(-50%);
    color: white;
    font-size: 0.875rem;
    font-weight: 500;
    background: rgba(0, 0, 0, 0.5);
    padding: 0.5rem 1rem;
    border-radius: 9999px;
  }

  .lightbox-image-wrapper {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    padding: 3rem 0;
    min-height: 0;
  }

  .lightbox-nav {
    flex-shrink: 0;
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.1);
    border: none;
    border-radius: 50%;
    color: white;
    cursor: pointer;
    transition: background 0.2s ease, transform 0.2s ease;
  }

  .lightbox-nav:hover {
    background: rgba(255, 255, 255, 0.25);
    transform: scale(1.1);
  }

  .lightbox-image-container {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    max-height: 100%;
    overflow: hidden;
  }

  .lightbox-image {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    border-radius: 0.5rem;
    transition: transform 0.3s ease;
  }

  .lightbox-thumbnails {
    flex-shrink: 0;
    padding-top: 1rem;
  }

  .lightbox-thumbnail-strip {
    display: flex;
    gap: 0.5rem;
    justify-content: center;
    overflow-x: auto;
    padding: 0.5rem;
    scrollbar-width: none;
    -ms-overflow-style: none;
  }

  .lightbox-thumbnail-strip::-webkit-scrollbar {
    display: none;
  }

  .lightbox-thumb {
    flex-shrink: 0;
    width: 64px;
    height: 48px;
    border: 2px solid transparent;
    border-radius: 0.375rem;
    overflow: hidden;
    cursor: pointer;
    opacity: 0.5;
    transition: opacity 0.2s ease, border-color 0.2s ease, transform 0.2s ease;
    background: none;
    padding: 0;
  }

  .lightbox-thumb:hover {
    opacity: 0.8;
  }

  .lightbox-thumb.active {
    opacity: 1;
    border-color: #0ea5e9;
    transform: scale(1.05);
  }

  .lightbox-thumb img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  /* Mobile adjustments */
  @media (max-width: 640px) {
    .lightbox-nav {
      width: 40px;
      height: 40px;
    }

    .lightbox-nav svg {
      width: 1.25rem;
      height: 1.25rem;
    }

    .lightbox-thumb {
      width: 48px;
      height: 36px;
    }
  }

  /* Prevent body scroll when lightbox is open */
  body.lightbox-open {
    overflow: hidden;
  }
</style>

<script>
  // Gallery elements
  const mainImage = document.getElementById('main-image') as HTMLImageElement;
  const currentIndexEl = document.getElementById('current-index');
  const thumbnails = document.querySelectorAll('.thumbnail');
  const prevBtn = document.getElementById('prev-btn');
  const nextBtn = document.getElementById('next-btn');
  const thumbnailContainer = document.getElementById('thumbnail-container');

  // Lightbox elements
  const lightbox = document.getElementById('lightbox');
  const lightboxImage = document.getElementById('lightbox-image') as HTMLImageElement;
  const lightboxClose = document.getElementById('lightbox-close');
  const lightboxPrev = document.getElementById('lightbox-prev');
  const lightboxNext = document.getElementById('lightbox-next');
  const lightboxCurrentEl = document.getElementById('lightbox-current');
  const lightboxThumbs = document.querySelectorAll('.lightbox-thumb');
  const lightboxOverlay = lightbox?.querySelector('.lightbox-overlay');

  let currentIndex = 0;
  const totalImages = thumbnails.length;
  let isLightboxOpen = false;

  function updateImage(index: number) {
    if (index < 0 || index >= totalImages) return;

    currentIndex = index;
    const thumbnail = thumbnails[index] as HTMLElement;
    const img = thumbnail.querySelector('img') as HTMLImageElement;
    const imgSrc = img?.src || '';

    // Update main image
    if (mainImage) mainImage.src = imgSrc;
    if (currentIndexEl) currentIndexEl.textContent = (index + 1).toString();

    // Update thumbnail borders
    thumbnails.forEach((thumb, i) => {
      if (i === index) {
        thumb.classList.remove('border-transparent', 'hover:border-secondary-300');
        thumb.classList.add('border-primary-500', 'ring-2', 'ring-primary-200');
      } else {
        thumb.classList.remove('border-primary-500', 'ring-2', 'ring-primary-200');
        thumb.classList.add('border-transparent', 'hover:border-secondary-300');
      }
    });

    // Scroll thumbnail into view
    if (thumbnailContainer) {
      const thumbnailWidth = thumbnail.offsetWidth + 8;
      const containerWidth = thumbnailContainer.offsetWidth;
      const scrollPosition = thumbnailWidth * index - containerWidth / 2 + thumbnailWidth / 2;
      thumbnailContainer.scrollTo({
        left: scrollPosition,
        behavior: 'smooth'
      });
    }

    // Update lightbox if open
    if (isLightboxOpen) {
      updateLightboxImage(index);
    }
  }

  function updateLightboxImage(index: number) {
    const thumbnail = thumbnails[index] as HTMLElement;
    const img = thumbnail.querySelector('img') as HTMLImageElement;
    const imgSrc = img?.src || '';

    if (lightboxImage) lightboxImage.src = imgSrc;
    if (lightboxCurrentEl) lightboxCurrentEl.textContent = (index + 1).toString();

    // Update lightbox thumbnails
    lightboxThumbs.forEach((thumb, i) => {
      thumb.classList.toggle('active', i === index);
    });
  }

  function openLightbox() {
    if (!lightbox) return;
    isLightboxOpen = true;
    lightbox.classList.add('active');
    document.body.classList.add('lightbox-open');
    updateLightboxImage(currentIndex);
  }

  function closeLightbox() {
    if (!lightbox) return;
    isLightboxOpen = false;
    lightbox.classList.remove('active');
    document.body.classList.remove('lightbox-open');
  }

  function goPrevImage() {
    const newIndex = currentIndex > 0 ? currentIndex - 1 : totalImages - 1;
    updateImage(newIndex);
  }

  function goNextImage() {
    const newIndex = currentIndex < totalImages - 1 ? currentIndex + 1 : 0;
    updateImage(newIndex);
  }

  // Main image click - open lightbox
  mainImage?.addEventListener('click', openLightbox);

  // Thumbnail click handlers
  thumbnails.forEach((thumbnail, index) => {
    thumbnail.addEventListener('click', () => updateImage(index));
  });

  // Previous button
  prevBtn?.addEventListener('click', (e) => {
    e.stopPropagation();
    goPrevImage();
  });

  // Next button
  nextBtn?.addEventListener('click', (e) => {
    e.stopPropagation();
    goNextImage();
  });

  // Lightbox controls
  lightboxClose?.addEventListener('click', closeLightbox);
  lightboxOverlay?.addEventListener('click', closeLightbox);
  lightboxPrev?.addEventListener('click', goPrevImage);
  lightboxNext?.addEventListener('click', goNextImage);

  // Lightbox thumbnail clicks
  lightboxThumbs.forEach((thumb, index) => {
    thumb.addEventListener('click', () => updateImage(index));
  });

  // Keyboard navigation
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && isLightboxOpen) {
      closeLightbox();
      return;
    }
    if (e.key === 'ArrowLeft') goPrevImage();
    if (e.key === 'ArrowRight') goNextImage();
  });

  // Touch swipe support for lightbox
  let touchStartX = 0;

  lightbox?.addEventListener('touchstart', (e: TouchEvent) => {
    touchStartX = e.changedTouches[0].screenX;
  }, { passive: true });

  lightbox?.addEventListener('touchend', (e: TouchEvent) => {
    const touchEndX = e.changedTouches[0].screenX;
    const diff = touchStartX - touchEndX;
    if (Math.abs(diff) > 50) {
      diff > 0 ? goNextImage() : goPrevImage();
    }
  }, { passive: true });
</script>
