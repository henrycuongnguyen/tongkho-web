# System Architecture

## High-Level Overview

```
┌─────────────────────────────────────────────────────────┐
│                    TONGKHO-WEB ARCHITECTURE              │
└─────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────┐
│                      BROWSER (User)                          │
│  (Zero JavaScript - Static HTML only)                        │
└──────────────────────────────────────────────────────────────┘
                              ↓
┌──────────────────────────────────────────────────────────────┐
│                   STATIC HTML/CSS OUTPUT                      │
│  (Generated by Astro at build time)                          │
│  - Homepage (index.html)                                     │
│  - Sitemap (sitemap.xml)                                     │
│  - Assets (CSS, images, fonts)                               │
└──────────────────────────────────────────────────────────────┘
                              ↓
┌──────────────────────────────────────────────────────────────┐
│                    STATIC FILE SERVER                         │
│  (nginx, Netlify, Vercel, Cloudflare Pages, etc.)           │
│  - No server-side rendering                                  │
│  - No database queries                                       │
│  - CDN-friendly caching                                      │
└──────────────────────────────────────────────────────────────┘
```

---

## Technology Stack

### Build Tools
- **Astro 5.2:** Static site generator with zero JavaScript output
- **Vite:** Underlying bundler for development & production builds
- **TypeScript 5.7:** Type-safe code with strict mode

### Rendering Engines
- **React 19:** Component library (prerendered to static HTML)
- **JSX:** Component syntax (Astro files + React components)

### Styling
- **Tailwind CSS 3.4:** Utility-first CSS framework
- **Autoprefixer:** Vendor prefix handling
- **Custom CSS:** Scoped styles in Astro components

### Content & Assets
- **Mock Data:** TypeScript arrays in `src/data/`
- **Icons:** Lucide via Iconify JSON
- **Images:** Static assets in `public/`
- **Fonts:** Inter (body), Be Vietnam Pro (headings)

### Integrations
- **@astrojs/react:** React component prerendering
- **@astrojs/tailwind:** Tailwind CSS integration
- **@astrojs/sitemap:** XML sitemap generation
- **@astrojs/check:** TypeScript validation

---

## Project Structure

### Directory Organization

```
src/
├── components/
│   ├── cards/           # Reusable card components
│   │   └── property-card.astro
│   ├── footer/          # Footer section
│   │   └── footer.astro
│   ├── header/          # Header & navigation
│   │   ├── header.astro
│   │   ├── header-mobile-menu.tsx
│   │   └── header-nav-data.ts
│   └── home/            # Homepage sections
│       ├── hero-section.astro
│       ├── hero-search.tsx
│       ├── featured-project-section.astro
│       ├── properties-section.astro
│       ├── locations-section.astro
│       ├── customers-section.astro
│       └── news-section.astro
├── data/
│   └── mock-properties.ts  # All mock data (properties, projects, news)
├── layouts/
│   ├── base-layout.astro   # HTML <head>, meta tags, fonts
│   └── main-layout.astro   # Header + <main> + footer wrapper
├── pages/
│   └── index.astro         # Homepage
├── styles/
│   └── global.css          # Global Tailwind + custom styles
├── types/
│   └── property.ts         # TypeScript interfaces
└── utils/
    └── format.ts           # Formatting utilities (price, date, slug)

public/
├── favicon.svg
├── robots.txt
└── images/
    ├── hero-background.jpg
    ├── logo.svg
    └── ...

dist/                       # Build output (auto-generated)
├── index.html
├── sitemap.xml
├── styles/
└── images/
```

---

## Data Flow Architecture

### 1. Development Pipeline
```
TypeScript Code
    ↓
Astro Compiler
    ↓
React Prerender
    ↓
Tailwind CSS Processing
    ↓
Static HTML + CSS
```

### 2. Component Composition
```
pages/index.astro (Homepage)
├── layouts/main-layout.astro
│   ├── components/header/header.astro
│   │   └── header-nav-data.ts (NavItems)
│   ├── components/header/header-mobile-menu.tsx (React)
│   │
│   ├── components/home/hero-section.astro
│   ├── components/home/hero-search.tsx (React)
│   │   └── header-nav-data.ts (Cities, types, filters)
│   │
│   ├── components/home/featured-project-section.astro
│   │   └── mock-properties.ts (mockProjects)
│   │
│   ├── components/home/properties-section.astro
│   │   ├── components/cards/property-card.astro
│   │   └── mock-properties.ts (mockProperties)
│   │
│   ├── components/home/locations-section.astro
│   │   └── mock-properties.ts (mockLocations)
│   │
│   ├── components/home/customers-section.astro
│   │
│   ├── components/home/news-section.astro
│   │   └── mock-properties.ts (mockNews)
│   │
│   └── components/footer/footer.astro
│       └── header-nav-data.ts (NavItems)
```

### 3. Data Source: Mock Data
```typescript
mock-properties.ts (single source of truth)
├── mockProperties: Property[]
├── mockProjects: Project[]
├── mockNews: NewsArticle[]
└── mockLocations: Location[]
     ↓ imported by ↓
  Section components → Rendered as HTML
```

### 4. Styling Pipeline
```
tailwind.config.mjs (define colors, fonts)
    ↓
global.css (@tailwind directives)
    ↓
Component styles (<style> blocks)
    ↓
Tailwind utility classes (inline in HTML)
    ↓
Final CSS bundle
```

---

## Component Architecture

### Astro Components (Server-Side)
Rendered at build time; output as static HTML.

```
property-card.astro
  Props: { property: Property }
  Output: <article> with price, image, title
  Logic: Format price, generate slug

hero-search.tsx (React wrapped in Astro)
  Props: { onSearch?: callback }
  Output: <form> with filters
  Logic: Handle user interaction (if client:load)

featured-project-section.astro
  Props: { projects: Project[] }
  Output: <section> grid of <ProjectCard>
  Logic: Filter featured projects, map cards
```

### React Components (Prerendered)
Rendered to static HTML during build; no JavaScript on page.

```
hero-search.tsx
  - Transaction type tabs (buy/rent/project)
  - City selector
  - Property type dropdown
  - Price range slider
  - Area range slider
  - Keyword input
  - Search button

header-mobile-menu.tsx
  - Mobile navigation toggle
  - Menu items
  - Close on navigation
```

### Layout Hierarchy
```
base-layout.astro
  └─ All pages use this
     - HTML doctype, <head> meta, fonts
     - Tailwind CSS injection
     - Analytics scripts (if any)

main-layout.astro
  └─ Wraps content pages
     - <header> (navigation)
     - <main> (page content slot)
     - <footer> (links, contact)
```

---

## Data Models & Type System

### Property Listing Model
```
Property {
  id: string                    // Unique identifier
  title: string                 // "Căn hộ cao cấp tại Hà Nội"
  slug: string                  // "can-ho-cao-cap-tai-ha-noi"
  type: PropertyType            // apartment | house | villa | ...
  transactionType: TransactionType  // sale | rent
  price: number                 // 5500 (if billion), 500 (if million)
  priceUnit: PriceUnit          // billion | million | per_month | VND
  area: number                  // 120 (m²)
  bedrooms?: number             // 3 (optional)
  bathrooms?: number            // 2 (optional)
  address: string               // "123 Phạm Văn Đồng"
  district: string              // "Cầu Giấy"
  city: string                  // "Hà Nội"
  description: string           // Long description
  images: string[]              // [url1, url2, ...]
  thumbnail: string             // Primary image URL
  features: string[]            // ["Có ban công", "Tầng cao"]
  createdAt: string             // ISO date
  isFeatured: boolean           // Show in featured section
  isHot: boolean                // Show hot badge
}
```

### Project Model
```
Project {
  id: string
  name: string                  // Project name
  slug: string
  developer: string             // Developer company
  location: string              // "Quận 7, TP.HCM"
  city: string
  status: ProjectStatus         // upcoming | selling | sold_out | completed
  totalUnits: number            // 500 units
  priceRange: string            // "5.5 tỷ - 10 tỷ"
  area: string                  // "50 - 150 m²"
  description: string
  images: string[]
  thumbnail: string
  amenities: string[]           // ["Gym", "Pool", "Parking"]
  completionDate?: string       // ISO date
  isFeatured: boolean
}
```

### News/Article Model
```
NewsArticle {
  id: string
  title: string
  slug: string
  excerpt: string               // Preview text
  content: string               // Full article (markdown or HTML)
  thumbnail: string
  category: NewsCategory        // market | policy | tips | project_news | investment
  author: string                // "Bộ phận Quản lý Nội dung"
  publishedAt: string           // ISO date
  views: number                 // Article view count
}
```

### Search Filters Model
```
SearchFilters {
  transactionType: TransactionType  // Required: sale | rent
  city?: string                     // "ha-noi"
  keyword?: string                  // Free text search
  propertyType?: PropertyType       // apartment | house | ...
  priceMin?: number                 // Minimum price
  priceMax?: number                 // Maximum price
  areaMin?: number                  // Minimum area m²
  areaMax?: number                  // Maximum area m²
}
```

---

## Build & Deployment Flow

### Development
```
npm run dev
  └─ Starts Astro dev server on http://localhost:3000
     - Hot reload on file changes
     - In-memory builds (fast iteration)
     - Full TypeScript checking
```

### Production Build
```
npm run build
  ├─ Step 1: astro check
  │   └─ TypeScript validation (strict mode)
  ├─ Step 2: astro build
  │   ├─ Scan src/pages → generate routes
  │   ├─ Render Astro components to HTML
  │   ├─ Prerender React components
  │   ├─ Process Tailwind CSS
  │   └─ Bundle assets
  └─ Output: dist/ directory
     ├─ index.html (homepage)
     ├─ sitemap.xml
     ├─ _astro/ (CSS, JS chunks)
     └─ images/
```

### Output Characteristics
- **Zero JavaScript:** All interactive React components prerendered
- **Static HTML:** Served by any static file server
- **SEO Optimized:** Sitemap, meta tags, structured data ready
- **Cache Friendly:** Content hashing for long-term caching
- **Performance:** <2 second load time (depends on hosting)

### Deployment Options
- **Netlify:** `netlify deploy --prod`
- **Vercel:** Connect GitHub repo for auto-deploy
- **Cloudflare Pages:** Upload dist/ folder or connect Git
- **Self-hosted:** Copy dist/ to web server (nginx, Apache)

---

## Vietnamese Localization Architecture

### Formatting Utilities (format.ts)
```
formatPrice()         → "5.5 tỷ", "500 triệu", "15 triệu/tháng"
formatNumber()        → "1.500.000" (Vietnamese thousand sep)
formatDate()          → "28 tháng 1 năm 2026"
formatRelativeTime()  → "2 ngày trước", "Hôm qua"
generateSlug()        → "dấu-tiếng-việt" → "dau-tieng-viet"
truncateText()        → Ellipsis for long text
```

### Content Data (header-nav-data.ts)
```
mainNavItems[]   → Navigation menu in Vietnamese
cities[]         → Hà Nội, TP.HCM, Đà Nẵng, etc.
propertyTypes[]  → Căn hộ, Nhà riêng, Biệt thự, etc.
priceRanges[]    → Dưới 500 triệu, 500M - 1T, etc.
areaRanges[]     → < 30m², 30-50m², 50-80m², etc.
```

### Language Considerations
- All UI text in Vietnamese
- Vietnamese character handling in slugs
- Regional number/currency formatting
- Date format: day tháng month năm year

---

## Performance Considerations

### Optimization Strategies
1. **Static Generation:** Eliminate runtime overhead
2. **CSS Optimization:** Tailwind purges unused styles
3. **Image Optimization:** Next-gen formats (WebP), lazy loading
4. **Code Splitting:** Automatic by Astro build system
5. **Caching:** Long-term caching via content hashing

### Metrics
| Metric | Target |
|---|---|
| Lighthouse Performance | >90 |
| First Contentful Paint | <1 second |
| Cumulative Layout Shift | <0.1 |
| Time to Interactive | <1 second |
| Total Bundle Size | <3 MB |

---

## Security Architecture

### Client-Side Security
- No sensitive data in client-side code
- No API keys in frontend
- No user authentication logic exposed
- Future: CSP headers, X-Frame-Options

### Server-Side (None)
- Static output only; no server-side logic
- Future backend: API layer separate from frontend

### Data Privacy
- No tracking scripts (no Google Analytics)
- Future: Privacy policy, GDPR compliance
- No user registration/login (yet)

---

## Scalability & Future Evolution

### Phase 1 (Current): Static Frontend
- Single index.html homepage
- Mock data only
- Static deployment

### Phase 2: Dynamic Pages
- Property detail pages (dynamic routes)
- Project detail pages
- Article pages
- SEO per page (meta tags, Open Graph)

### Phase 3: Backend Integration (In Progress)
**Current Status:** Backend services implemented for data fetching

#### Elasticsearch Integration
- **Service:** `src/services/elasticsearch-property-service.ts`
- **Approach:** REST API via `fetch` (no client library dependency)
- **Authentication:** API Key in Authorization header
- **Available Indices:**
  - `real_estate` - Property listings (default)
  - `project` - Real estate projects
  - `locations` - Location/area data
  - `seo_meta_data` - SEO metadata for pages
- **Features:**
  - Search properties by transaction type (sale/rent)
  - Search across multiple indices (e.g., locations + projects)
  - Sort by creation date
  - Full-text search with fuzziness
  - Price and area range filtering
  - Generic search method for custom queries

#### PostgreSQL Integration
- **Service:** `src/services/postgres-news-project-service.ts`
- **Library:** `pg` (node-postgres)
- **Connection:** Connection pool with configurable limits
- **Tables:**
  - `news` - Articles from different folders/categories
  - `project` - Real estate projects with metadata
- **Features:**
  - Fetch news by slug and categories
  - Get latest news articles
  - Retrieve featured projects
  - Fallback to active projects if no featured

#### Environment Variables
```bash
# Elasticsearch
ES_URL=https://elastic.tongkhobds.com
ES_INDEX=real_estate
ES_API_KEY=your_api_key_here

# PostgreSQL
DATABASE_URL=postgres://username:password@host:5432/database
```

#### Service Architecture
```
src/services/
├── elasticsearch/                           # Elasticsearch services (modular)
│   ├── base.service.ts                     # Shared base class with search logic
│   ├── property.service.ts                 # Property-specific searches
│   │   ├── searchProperties(transactionType, limit)
│   │   ├── mapToProperty() - Transform to Property type
│   │   └── parsePriceDescription() - Parse Vietnamese price
│   ├── project.service.ts                  # Project-specific searches
│   │   └── searchProjects(query?, limit)
│   ├── location.service.ts                 # Location-specific searches
│   │   ├── searchLocations(query?, limit)
│   │   └── searchLocationsAndProjects() - Combined search
│   ├── seo.service.ts                      # SEO metadata searches
│   │   └── getSeoMetadata(path)
│   ├── constants.ts                        # ES_INDICES, mappings, types
│   └── index.ts                            # Barrel export
│
├── postgres-news-project-service.ts
│   ├── PostgresNewsProjectService class
│   ├── getLatestNews(limit)
│   ├── getNewsBySlug(slug)
│   ├── getFeaturedProjects(limit)
│   └── mapToNewsArticle/mapToProject() - Transform DB rows
│
└── postgres-property-service.ts
    └── Additional property queries
```

#### Design Decisions
- **Modular Services:** Each service handles one domain (property, project, location, SEO)
- **Inheritance:** All services extend ElasticsearchBaseService for shared logic
- **Fetch over Client Library:** Keeps dependencies minimal, easier debugging
- **Singleton Pattern:** Export service instances for reuse
- **Shared Base URL:** `https://quanly.tongkhobds.com` for image URLs
- **Type Safety:** All responses mapped to TypeScript interfaces
- **Error Handling:** Try-catch with console logging

### Phase 4: Advanced Features (Planned)
- Real-time property updates
- Map integration (Google Maps)
- Image gallery (lightbox)
- Lead generation forms
- User authentication

---

## Monitoring & Observability

### Current
- Manual testing
- TypeScript compilation checks
- Browser dev tools

### Planned
- Sentry (error tracking)
- Analytics (property views, search patterns)
- Performance monitoring
- SEO rank tracking

---

## Document History

| Version | Date | Changes |
|---|---|---|
| 1.0 | 2026-01-28 | Initial system architecture documentation |
| 1.1 | 2026-02-05 | Added backend integration details (Elasticsearch, PostgreSQL) |
